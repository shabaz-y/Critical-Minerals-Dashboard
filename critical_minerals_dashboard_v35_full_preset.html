<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Critical Minerals Dashboard — v3.5 (Full + Preset GBP Baseline)</title>
<meta http-equiv="refresh" content="900">
<style>
body{font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0b1220;color:#e6edf3}
header{padding:24px;background:#11192d;border-bottom:1px solid #23324f}
h1{margin:0 0 6px 0;font-size:24px} h2{margin-top:24px;font-size:20px}
p,li{color:#b8c3d6} .container{max-width:1280px;margin:0 auto;padding:16px 24px 40px}
.card{background:#0f1a33;border:1px solid #22345a;border-radius:12px;padding:16px}
.table{width:100%;border-collapse:collapse} .table th,.table td{border-bottom:1px solid #23324f;padding:8px 10px}
.tiny{font-size:12px;color:#8aa0c8} .right{text-align:right} .gain{color:#86efac} .loss{color:#fca5a5}
.btn{background:#1a2b4f;color:#cfe0ff;border:1px solid #2c4578;border-radius:8px;padding:8px 12px;cursor:pointer} .btn:hover{background:#233a6a}
.input{background:#0f1a33;border:1px solid #2c4578;color:#cfe0ff;padding:6px 8px;border-radius:6px}
.grid{display:grid;grid-template-columns:1fr;gap:20px}
.grid-3{display:grid;grid-template-columns:1fr;gap:20px}
.two-col{display:grid;grid-template-columns:1fr;gap:20px}
@media(min-width:900px){.grid{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr} .two-col{grid-template-columns:1fr 1fr}}
.pill{display:inline-block;padding:4px 10px;border:1px solid #2d4472;border-radius:999px;margin-right:8px;font-size:12px;color:#c8d6ef}
.matrix{width:100%;border-collapse:collapse} .matrix th,.matrix td{border:1px solid #23324f;padding:8px 10px;text-align:left} .matrix th{background:#0d1630}
.ok{color:#8fe388;font-weight:600} .warn{color:#ffd36e;font-weight:600}
.badge{padding:3px 8px;border-radius:6px;background:#1a2b4f;border:1px solid #2c4578;margin-left:8px;font-size:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
@keyframes flashGreen{0%{background:#0f1a33}50%{background:#10351f}100%{background:#0f1a33}}
@keyframes flashRed{0%{background:#0f1a33}50%{background:#3a1b1b}100%{background:#0f1a33}}
.flashUp{animation:flashGreen 1.2s ease-in-out 4} .flashDown{animation:flashRed 1.2s ease-in-out 4}
.alertInput{width:70px;background:#0f1a33;border:1px solid #2c4578;color:#cfe0ff;padding:6px 8px;border-radius:6px}
.inline-note{font-size:12px;color:#8aa0c8;margin-left:8px}
</style>
</head>
<body>
<header><div class="container">
  <h1>U.S. Policy Critical Minerals — v3.5 <span class="badge">Preset Baseline + Alerts + Policy</span></h1>
  <p class="tiny">Your exact Trading212 fills (GBP) are locked as baseline. Toggle display currency, get alerts, and track policy catalysts. Auto-refresh 15m.</p>
  <div><span class="pill">MP</span><span class="pill">LYSDY</span><span class="pill">ABAT</span><span class="pill">NVX</span><span class="pill">WWR</span><span class="pill">LAC</span><span class="pill">METC</span><span class="pill">NB</span><span class="pill">URA</span><span class="pill">REMX</span></div>
</div></header>

<div class="container">

  <!-- P&L + Alerts -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <h2 style="margin:0;">Portfolio P&L (Preset Baseline)</h2>
      <div class="row">
        <label>Data source:</label>
        <select id="sourceSel" class="input">
          <option value="auto">Auto (Finnhub→Yahoo→Manual)</option>
          <option value="finnhub">Finnhub (API key)</option>
          <option value="yahoo">Yahoo (multi-proxy)</option>
          <option value="manual">Manual (type prices)</option>
        </select>
        <label>Finnhub API key:</label><input id="apiKey" class="input" placeholder="optional" style="min-width:220px">
        <button class="btn" id="saveKey">Save</button>
        <label style="margin-left:10px">Display:</label>
        <select id="ccy" class="input"><option value="GBP">GBP</option><option value="USD">USD</option></select>
        <button class="btn" id="recalc">Recalculate</button>
      </div>
    </div>
    <p class="tiny">Baseline = your exact paid price (GBP, incl. fees) × exact quantity. Live stock quotes fetched in USD; converted using live GBPUSD.</p>
    <table class="table" id="pnlTable">
      <thead><tr>
        <th>Symbol</th><th class="right">Qty</th><th class="right">Baseline £/sh</th><th class="right">Baseline £</th>
        <th class="right">Live Price</th><th class="right">Live Value</th><th class="right">P&L %</th><th class="right">Alert ±%</th>
      </tr></thead>
      <tbody></tbody>
      <tfoot><tr>
        <th>Total</th><th></th><th></th><th class="right" id="totBase"></th>
        <th></th><th class="right" id="totLive"></th><th class="right" id="totPL"></th><th></th>
      </tr></tfoot>
    </table>
    <p class="tiny" id="fxNote">FX: loading…</p>
    <p class="tiny" id="sourceNote">Source: Auto</p>
    <div class="card" style="margin-top:12px;">
      <h3 style="margin-top:0;">Alert Log</h3>
      <ul id="alertLog" class="tiny" style="max-height:180px; overflow:auto; padding-left:18px; margin:0;"></ul>
      <p class="tiny">Rows flash when your P&L crosses the ±% threshold you set per symbol.</p>
    </div>
  </div>

  <!-- Catalyst Timeline + Policy Map -->
  <div class="grid">
    <div class="card">
      <h2>Catalyst Timeline</h2>
      <ul>
        <li><strong>Section 232 Report Window:</strong> Oct–Dec 2025. <span id="countdown232"></span></li>
        <li><strong>DOE Loans & Grants:</strong> Rolling announcements; watch ABAT, LAC, NVX.</li>
        <li><strong>DPA / DoD Contracts:</strong> Ongoing; key for MP, LYSDY, NB.</li>
        <li><strong>Election Policy Cycle:</strong> 2026 — resource independence rhetoric likely supportive.</li>
      </ul>
    </div>

    <div class="card">
      <h2>Policy Exposure Map</h2>
      <table class="matrix">
        <thead><tr><th>Company</th><th>DOE Loans</th><th>DPA / DoD</th><th>IRA Credits</th><th>232 Sensitivity</th></tr></thead>
        <tbody>
          <tr><td>MP</td><td></td><td class="ok">High</td><td></td><td class="ok">High</td></tr>
          <tr><td>LYSDY</td><td></td><td class="ok">High</td><td></td><td class="ok">High</td></tr>
          <tr><td>ABAT</td><td class="ok">High</td><td></td><td class="ok">High</td><td class="warn">Medium</td></tr>
          <tr><td>NVX</td><td class="warn">Medium</td><td></td><td class="ok">High</td><td class="ok">High</td></tr>
          <tr><td>WWR</td><td class="warn">Medium</td><td></td><td></td><td class="ok">High</td></tr>
          <tr><td>LAC</td><td class="ok">High</td><td></td><td class="warn">Medium</td><td class="warn">Medium</td></tr>
          <tr><td>METC</td><td class="warn">Medium</td><td></td><td></td><td class="warn">Medium</td></tr>
          <tr><td>NB</td><td class="warn">Medium</td><td class="ok">High</td><td></td><td class="warn">Medium</td></tr>
        </tbody>
      </table>
      <p class="tiny">Legend: <span class="ok">High</span> = direct program fit; <span class="warn">Medium</span> = indirect/likely.</p>
    </div>
  </div>

  <!-- Charts & Quick Links -->
  <div class="card">
    <h2>Benchmarks & News</h2>
    <div class="grid-3">
      <div>
        <div class="tradingview-widget-container">
          <div id="uraChart"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
          {"symbol":"AMEX:URA","dateRange":"3M","locale":"en","colorTheme":"dark","isTransparent":false,"autosize":true,"height":220}
          </script>
        </div>
        <p class="tiny">URA — Uranium ETF</p>
      </div>
      <div>
        <div class="tradingview-widget-container">
          <div id="remxChart"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
          {"symbol":"AMEX:REMX","dateRange":"3M","locale":"en","colorTheme":"dark","isTransparent":false,"autosize":true,"height":220}
          </script>
        </div>
        <p class="tiny">REMX — Rare Earth/Strategic Metals ETF</p>
      </div>
      <div>
        <p class="tiny">Quick News Links</p>
        <ul>
          <li><a target="_blank" href="https://www.google.com/search?q=site%3Aenergy.gov+%22critical+minerals%22">Energy.gov — “critical minerals”</a></li>
          <li><a target="_blank" href="https://www.google.com/search?q=%22Section+232%22+critical+minerals">“Section 232” critical minerals</a></li>
          <li><a target="_blank" href="https://www.google.com/search?q=DOE+Loan+Program+Office+battery+recycling">DOE Loan Program — battery recycling</a></li>
          <li><a target="_blank" href="https://www.google.com/search?q=site%3Adefense.gov+rare+earths+contract">Defense.gov — rare earths contract</a></li>
        </ul>
      </div>
    </div>
  </div>

</div>

<footer><div class="container"><p class="tiny">This dashboard is informational only and not investment advice.</p></div></footer>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
// ---------- COUNTDOWN ----------
const target = new Date('2025-12-31T23:59:59Z').getTime();
function updateCountdown() {
  const el = document.getElementById('countdown232'); if (!el) return;
  const now = new Date().getTime(); const diff = target - now;
  if (diff <= 0) { el.textContent = 'Window complete'; return; }
  const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000), m = Math.floor((diff%3600000)/60000);
  el.textContent = d+'d '+h+'h '+m+'m';
} updateCountdown(); setInterval(updateCountdown, 60000);

// ---------- CONSTANTS ----------
const BASELINE = {"NVX":{"qty":116.02665722,"gbp_price":1.318662483828128},"WWR":{"qty":103.71416362,"gbp_price":0.9834722321410165},"LAC":{"qty":14.45613944,"gbp_price":7.055825687303968},"MP":{"qty":3.73002456,"gbp_price":54.69132889570036},"ABAT":{"qty":39.26264742,"gbp_price":3.896833505986744},"METC":{"qty":3.554888501,"gbp_price":28.692883045785294},"NB":{"qty":7.63016615,"gbp_price":6.683995996600939},"LYSDY":{"qty":15.45599858,"gbp_price":9.899069232445543}}; // GBP baseline & qty
const TICKERS = Object.keys(BASELINE);
const LS = {
  alerts: 'cm_v35_alerts', log: 'cm_v35_alertlog', ccy: 'cm_v35_ccy',
  source: 'cm_v35_source', key: 'cm_v35_finnhub_key'
};
const defaultAlerts = { MP:7, LYSDY:7, ABAT:10, NVX:10, WWR:15, LAC:10, METC:8, NB:12 };

// ---------- HELPERS ----------
function fmt(n,d=2){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}); }
function cls(v){ return v>=0?'gain':'loss'; }
function readLS(k,f){ try{const x=JSON.parse(localStorage.getItem(k));return x??f;}catch(e){return f;} }
function writeLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function getAlerts(){ const a=readLS(LS.alerts,{}); let ch=false; Object.keys(defaultAlerts).forEach(s=>{if(a[s]==null){a[s]=defaultAlerts[s]; ch=true;}}); if(ch) writeLS(LS.alerts,a); return a; }
function setAlert(sym, th){ const a=getAlerts(); a[sym]=th; writeLS(LS.alerts,a); }

function logPush(e){
  const log=readLS(LS.log,[]); log.unshift(e); writeLS(LS.log, log.slice(0,100)); renderLog();
}
function renderLog(){
  const ul=document.getElementById('alertLog'); const log=readLS(LS.log,[]); ul.innerHTML='';
  log.forEach(e=>{const li=document.createElement('li'); li.textContent='['+new Date(e.t).toLocaleString()+'] '+e.sym+' ±'+e.th+'% → '+fmt(e.pl,2)+'%'; ul.appendChild(li);});
}

// ---------- QUOTES: Yahoo + Proxies + Finnhub ----------
function yahooUrl(t){ return `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(t.join(','))}`; }
function withProxy(url,p){ if(p==='direct')return url; if(p==='jina')return 'https://r.jina.ai/'+url; if(p==='allorigins')return 'https://api.allorigins.win/raw?url='+encodeURIComponent(url); if(p==='thing')return 'https://thingproxy.freeboard.io/fetch/'+url; }
const PROX = ['direct','jina','allorigins','thing'];

async function fetchYahoo(t){
  let last=''; for(const p of PROX){
    try{
      const res=await fetch(withProxy(yahooUrl(t),p),{cache:'no-store'}); const txt=await res.text();
      if(!txt.trim().startsWith('{')) throw new Error('Non-JSON');
      const j=JSON.parse(txt); const out={}; (j.quoteResponse.result||[]).forEach(q=>{out[q.symbol]=q.regularMarketPrice??q.ask??q.bid;});
      if(Object.keys(out).length) return {via: (p==='direct'?'Yahoo (direct)':'Yahoo via '+p), data: out}; last='empty';
    }catch(e){ last=e.message; }
  } throw new Error('Yahoo failed: '+last);
}

async function fetchFinnhub(t, key){
  const out={}; for(const s of t){ try{ const r=await fetch(`https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(s)}&token=${encodeURIComponent(key)}`,{cache:'no-store'}); const j=await r.json(); if(j && j.c) out[s]=j.c; }catch(e){} }
  if(Object.keys(out).length===0) throw new Error('Finnhub returned no prices.');
  return {via:'Finnhub', data:out};
}

async function fetchManual(t){
  const out={}; for(const s of t){ const v=prompt('Enter price for '+s+':',''); if(v==null) continue; const n=Number(v); if(!isNaN(n)&&n>0) out[s]=n; }
  if(Object.keys(out).length===0) throw new Error('No manual prices entered.');
  return {via:'Manual', data:out};
}

async function getQuotes(){
  const tickers=[...TICKERS,'GBPUSD=X']; const src=localStorage.getItem(LS.source)||'auto'; const key=localStorage.getItem(LS.key)||'';
  if(src==='finnhub') return await fetchFinnhub(tickers, key);
  if(src==='yahoo') return await fetchYahoo(tickers);
  if(src==='manual') return await fetchManual(tickers);
  // auto
  if(key){ try{ return await fetchFinnhub(tickers, key); }catch(e){} }
  try{ return await fetchYahoo(tickers); }catch(e){}
  return await fetchManual(tickers);
}

// ---------- RENDER ----------
const ccySel=document.getElementById('ccy'); ccySel.value=localStorage.getItem(LS.ccy)||'GBP';
ccySel.addEventListener('change',()=>{localStorage.setItem(LS.ccy, ccySel.value); render();});
document.getElementById('saveKey').addEventListener('click',()=>{ const v=document.getElementById('apiKey').value.trim(); if(v) localStorage.setItem(LS.key,v); localStorage.setItem(LS.source,'finnhub'); document.getElementById('sourceSel').value='finnhub'; document.getElementById('sourceNote').textContent='Source: Finnhub'; render(); });
const sel=document.getElementById('sourceSel'); sel.value=localStorage.getItem(LS.source)||'auto'; sel.addEventListener('change',e=>{ localStorage.setItem(LS.source,e.target.value); document.getElementById('sourceNote').textContent='Source: '+e.target.value; render(); });
document.getElementById('recalc').addEventListener('click',()=> render());

function renderAlertsInputs(){
  const a=getAlerts();
  TICKERS.forEach(sym=>{
    const inp=document.getElementById('alert-'+sym);
    if(inp){ inp.value=a[sym]; inp.addEventListener('change',e=>{ const v=Number(e.target.value); if(!isNaN(v)&&v>0) setAlert(sym,v); }); }
  });
}

async function render(){
  renderLog();
  const tbody=document.querySelector('#pnlTable tbody'); tbody.innerHTML='<tr><td colspan="8">Loading…</td></tr>';
  try{
    const {via, data} = await getQuotes();
    document.getElementById('sourceNote').textContent='Source: '+via;
    const fx = data['GBPUSD=X']; // USD per GBP
    document.getElementById('fxNote').textContent = 'FX (USD per £): '+ (fx?fmt(fx,4):'n/a');
    const ccy = ccySel.value;
    const toDisp = usd => ccy==='USD' ? usd : (usd / (fx||1));
    const dispSym = ccy==='USD' ? '$' : '£';

    const alerts = getAlerts();
    let totBaseGBP=0, totBaseDisp=0, totLiveDisp=0;
    tbody.innerHTML='';

    for(const sym of TICKERS){
      const bl=BASELINE[sym]; const qty=bl.qty; const baseGBP=bl.gbp_price;
      const liveUSD=data[sym];
      if(!qty || !liveUSD) continue;
      const liveDisp = toDisp(liveUSD);
      const baseValGBP = qty*baseGBP;
      const baseValDisp = ccy==='USD' ? baseValGBP*(fx||0) : baseValGBP;
      const liveValDisp = qty*liveDisp;
      const plPct = (liveValDisp - baseValDisp) / (baseValDisp||1) * 100;

      totBaseGBP += baseValGBP; totBaseDisp += baseValDisp; totLiveDisp += liveValDisp;

      const tr=document.createElement('tr');
      tr.id='row-'+sym;
      tr.innerHTML = `
        <td>${sym}</td>
        <td class="right">${fmt(qty,4)}</td>
        <td class="right">£${fmt(baseGBP)}</td>
        <td class="right">£${fmt(baseValGBP)}</td>
        <td class="right">${dispSym}${fmt(liveDisp)}</td>
        <td class="right">${dispSym}${fmt(liveValDisp)}</td>
        <td class="right ${cls(plPct)}">${fmt(plPct,2)}%</td>
        <td class="right"><input id="alert-${sym}" class="alertInput" type="number" step="0.5" min="1"><span class="inline-note">±%</span></td>`;
      tbody.appendChild(tr);

      const th = Number(alerts[sym]);
      if(th && Math.abs(plPct)>=th){ if(plPct>=0) tr.classList.add('flashUp'); else tr.classList.add('flashDown'); logPush({t:new Date().toISOString(), sym, th, pl:plPct}); }
    }

    document.getElementById('totBase').textContent='£'+fmt(totBaseGBP);
    document.getElementById('totLive').textContent=(dispSym)+fmt(totLiveDisp);
    const totPl = (totLiveDisp - totBaseDisp) / (totBaseDisp||1) * 100;
    document.getElementById('totPL').innerHTML = `<span class="${cls(totPl)}">${fmt(totPl,2)}%</span>`;

    renderAlertsInputs();

  }catch(e){
    tbody.innerHTML = `<tr><td colspan="8">Failed to load quotes/FX: ${e.message}</td></tr>`;
  }
}
render();
</script>

<!-- Ticker tape -->
<script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
{"symbols":[{"proName":"NYSE:MP","title":"MP"},{"proName":"OTC:LYSDY","title":"LYSDY"},{"proName":"NASDAQ:ABAT","title":"ABAT"},{"proName":"NASDAQ:NVX","title":"NVX"},{"proName":"AMEX:WWR","title":"WWR"},{"proName":"NYSE:LAC","title":"LAC"},{"proName":"NASDAQ:METC","title":"METC"},{"proName":"NASDAQ:NB","title":"NB"},{"proName":"AMEX:URA","title":"URA"},{"proName":"AMEX:REMX","title":"REMX"}],"colorTheme":"dark","isTransparent":false,"displayMode":"adaptive","locale":"en"}
</script>

</body>
</html>
